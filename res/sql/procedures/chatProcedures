DROP PROCEDURE IF EXISTS chat_add;
DROP PROCEDURE IF EXISTS chat_get;
drop view if exists message_view;
CREATE PROCEDURE chat_add(IN user_name INT, in message_in varchar(40))
BEGIN
  declare playerid int;
  select player_id into playerid from player join account a
    on player.user_id = a.user_id
      where user_name = username
        and player.active = 1;
  insert into chatmessage(player_id, time_in, message) values(playerid, now(), message_in);
END;



create view message_view as(
 select username, account.user_id, time_in, message, game_id from account
   join player p
    on account.user_id = p.user_id
      join chatmessage c
        on p.player_id = c.player_id
  );

create procedure chat_get(in gameid int)
  begin
  select username, cast(time_in as char) as time_String, message from message_view where game_id = gameid order by time_in asc;
  end;
